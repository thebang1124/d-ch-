// ✅ index.js — Đã thay API Gemini bằng OpenAI GPT-4 + Tesseract OCR

const OPENAI_API_KEY = "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";

async function callOpenAI(prompt, systemPrompt = "") {
  const response = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${OPENAI_API_KEY}`
    },
    body: JSON.stringify({
      model: "gpt-4",
      messages: [
        ...(systemPrompt ? [{ role: "system", content: systemPrompt }] : []),
        { role: "user", content: prompt }
      ]
    })
  });

  if (!response.ok) {
    const error = await response.text();
    throw new Error(`API Error: ${response.status} - ${error}`);
  }

  const data = await response.json();
  return data.choices?.[0]?.message?.content?.trim() || "Không có kết quả.";
}

// 🔁 Ví dụ sử dụng:

export async function translateWord(word, direction = 'edeToViet') {
  let prompt = "";
  if (direction === 'edeToViet') {
    prompt = `Dịch từ Êđê sang tiếng Việt: \"${word}\".`;
  } else {
    prompt = `Dịch từ tiếng Việt sang Êđê: \"${word}\".`;
  }
  return await callOpenAI(prompt, "Bạn là một trợ lý dịch tiếng Êđê - Việt.");
}

export async function generateExample(edeWord) {
  const prompt = `Tạo một câu ví dụ bằng tiếng Êđê sử dụng từ: \"${edeWord}\". Sau đó dịch câu đó sang tiếng Việt.`;
  return await callOpenAI(prompt, "Bạn là một trợ lý tạo ví dụ từ điển Êđê.");
}

export async function generateParagraph(topic) {
  const prompt = `Viết một đoạn văn ngắn bằng tiếng Êđê (3-5 câu) về chủ đề: \"${topic}\".`;
  return await callOpenAI(prompt, "Bạn là một giáo viên tiếng Êđê.");
}

export async function explainConcept(word) {
  const prompt = `Giải thích từ hoặc khái niệm tiếng Êđê sau bằng tiếng Việt: \"${word}\".`;
  return await callOpenAI(prompt, "Bạn là nhà ngôn ngữ học chuyên giải thích từ vựng tiếng Êđê bằng tiếng Việt.");
}

// 🖼️ OCR + Translate ảnh: dùng Tesseract.js để nhận dạng rồi GPT dịch
import Tesseract from 'tesseract.js';

export async function extractAndTranslateImage(imageFile) {
  const result = await Tesseract.recognize(imageFile, 'vie+eng', {
    logger: m => console.log(m)
  });

  const extractedText = result.data.text.trim();
  if (!extractedText) {
    throw new Error("Không tìm thấy văn bản trong ảnh.");
  }

  const translated = await callOpenAI(
    `Dịch đoạn văn tiếng Êđê sau sang tiếng Việt: \"${extractedText}\"`,
    "Bạn là một trợ lý dịch văn bản từ hình ảnh."
  );

  return { extractedText, translated };
}
